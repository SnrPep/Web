<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог машин</title>
</head>
<body>
    <h1>Каталог машин</h1>

    <form method="get">
        {{ filter.form.as_p }}
        <button type="submit">Фильтровать</button>

        {% if request.GET %}
            <a href="{% url 'car_catalog' %}" class="btn-reset">Сбросить фильтры</a>
        {% endif %}
    </form>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const brandSelect = document.getElementById("id_brand");
        const modelSelect = document.getElementById("id_model");

        brandSelect.addEventListener("change", function () {
            const brandId = brandSelect.value;

            // Отправляем запрос на сервер, чтобы получить модели
            fetch(`/cars/get-models/?brand_id=${brandId}`)
                .then(response => response.json())
                .then(data => {
                    // Очищаем предыдущие опции модели
                    modelSelect.innerHTML = '<option value="">Модель авто</option>';

                    // Добавляем новые модели в выпадающий список
                    data.models.forEach(function (model) {
                        const option = document.createElement("option");
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Ошибка при загрузке моделей:", error));
        });
    });
</script>

<form method="get" class="sorting-form">
    {% for key, value in request.GET.items %}
        {% if key != 'sort' %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endif %}
    {% endfor %}
    <label for="sort">Сортировка</label>
    <select name="sort" id="sort" onchange="this.form.submit()">
        <option value="" {% if not request.GET.sort %}selected{% endif %}>Сортировка</option>
        <option value="mileage" {% if request.GET.sort == "mileage" %}selected{% endif %}>Пробег: по возрастанию</option>
        <option value="-mileage" {% if request.GET.sort == "-mileage" %}selected{% endif %}>Пробег: по убыванию</option>
        <option value="price" {% if request.GET.sort == "price" %}selected{% endif %}>Стоимость: по возрастанию</option>
        <option value="-price" {% if request.GET.sort == "-price" %}selected{% endif %}>Стоимость: по убыванию</option>
        <option value="power_volume" {% if request.GET.sort == "power_volume" %}selected{% endif %}>Объем: по возрастанию</option>
        <option value="-power_volume" {% if request.GET.sort == "-power_volume" %}selected{% endif %}>Объем: по убыванию</option>
        <option value="year" {% if request.GET.sort == "year" %}selected{% endif %}>Год: по возрастанию</option>
        <option value="-year" {% if request.GET.sort == "-year" %}selected{% endif %}>Год: по убыванию</option>
    </select>
</form>
    <h2>Результаты</h2>
    <ul>
        {% for car in filter.qs %}
            <li>
                <img src="{{ car.random_image }}" alt="{{ car.random_image }}" width="200">
                <br>
                {{ car.brand_country.brand }} {{ car.make }} {{ car.model }} ({{ car.year }}) — {{ car.price }} ₽
                <br>Страна бренда: {{ car.brand_country.country }}
                <br>Пробег: {{ car.mileage }} км, Цвет: {{ car.color }}, КПП: {{ car.transmission }}
            </li>
        {% endfor %}
    </ul>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const sortSelect = document.getElementById("sort");
            sortSelect.addEventListener("change", function () {
                this.form.submit(); // Отправляем форму при изменении значения сортировки
            });
        });
    </script>
</body>
</html>